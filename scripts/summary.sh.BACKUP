#!/bin/bash
# ==========================================================
# AnchorPoint Monitoring - Executive Report Engine (Stable)
# ==========================================================

BRAND_NAME="AnchorPoint Monitoring"

HIGH_DISK_THRESHOLD=85
HIGH_MEM_THRESHOLD=85
HIGH_LOAD_THRESHOLD=2.0

if [ -z "$1" ]; then
    echo "Usage: ./summary.sh <hostname>"
    exit 1
fi

HOSTNAME=$1
DATE=$(date +%Y-%m-%d)
SOURCE_DIR="$HOME/monitoring-reports/$HOSTNAME"
RAW_REPORT=$(ls -t "$SOURCE_DIR"/*monitor*.log | head -n 1)

OUTPUT_LOG="$SOURCE_DIR/${HOSTNAME}-SUMMARY-${DATE}.log"
OUTPUT_HTML="$SOURCE_DIR/${HOSTNAME}-SUMMARY-${DATE}.html"

if [ ! -f "$RAW_REPORT" ]; then
    echo "No raw report found for $HOSTNAME"
    exit 1
fi

# ----------------------------------------------------------
# DISK USAGE
# ----------------------------------------------------------

DISK_USAGE=$(awk '$NF=="/"{print $5}' "$RAW_REPORT" | tr -d '%')
[ -z "$DISK_USAGE" ] && DISK_USAGE=0

# ----------------------------------------------------------
# MEMORY USAGE (ROBUST)
# ----------------------------------------------------------

MEM_PERCENT=$(awk '
/^Mem:/ {
    total=$2
    used=$3

    gsub("Gi","",total)
    gsub("Mi","",used)

    total_mi = total * 1024
    percent = (used / total_mi) * 100

    printf "%.0f", percent
}
' "$RAW_REPORT")

[ -z "$MEM_PERCENT" ] && MEM_PERCENT=0

# ----------------------------------------------------------
# CPU LOAD
# ----------------------------------------------------------

LOAD_AVG=$(grep "load average" "$RAW_REPORT" | \
    awk -F'load average:' '{print $2}' | \
    awk -F',' '{print $1}' | xargs)

[ -z "$LOAD_AVG" ] && LOAD_AVG=0

# ----------------------------------------------------------
# FAILED SSH
# ----------------------------------------------------------

if grep -A5 "Failed SSH Logins" "$RAW_REPORT" | grep -q "None"; then
    FAILED_LOGINS=0
else
    FAILED_LOGINS=$(grep -A5 "Failed SSH Logins" "$RAW_REPORT" \
        | grep -v "Failed SSH Logins" \
        | grep -v "----" \
        | wc -l | xargs)
fi

[ -z "$FAILED_LOGINS" ] && FAILED_LOGINS=0

# ----------------------------------------------------------
# NETWORK (DEFAULT 0 IF NOT PRESENT)
# ----------------------------------------------------------

RX_TOTAL=$(grep -m1 "Network RX" "$RAW_REPORT" | awk '{print $4}')
TX_TOTAL=$(grep -m1 "Network TX" "$RAW_REPORT" | awk '{print $4}')

[ -z "$RX_TOTAL" ] && RX_TOTAL=0
[ -z "$TX_TOTAL" ] && TX_TOTAL=0

# ----------------------------------------------------------
# RISK CALCULATION
# ----------------------------------------------------------

RISK="LOW"

if [ "$DISK_USAGE" -ge "$HIGH_DISK_THRESHOLD" ] || \
   [ "$MEM_PERCENT" -ge "$HIGH_MEM_THRESHOLD" ]; then
    RISK="HIGH"
elif (( $(echo "$LOAD_AVG > $HIGH_LOAD_THRESHOLD" | bc -l) )); then
    RISK="MEDIUM"
fi

# ----------------------------------------------------------
# EXEC SUMMARY (SHORT + CLEAN)
# ----------------------------------------------------------

EXEC_SUMMARY="All monitored system resources are operating within defined thresholds. No performance or security issues detected."

# ----------------------------------------------------------
# LOG OUTPUT
# ----------------------------------------------------------

{
echo "=================================================="
echo "$BRAND_NAME"
echo "Managed Systems Executive Report"
echo "--------------------------------------------------"
echo "Host: $HOSTNAME"
echo "Date: $DATE"
echo "=================================================="
echo ""
echo "Overall Risk Level: $RISK"
echo ""
echo "Disk Usage (Root): $DISK_USAGE%"
echo "Memory Usage: $MEM_PERCENT%"
echo "CPU Load (1-min avg): $LOAD_AVG"
echo "Failed SSH Attempts: $FAILED_LOGINS"
echo "Network RX: $RX_TOTAL"
echo "Network TX: $TX_TOTAL"
echo ""
echo "Executive Summary:"
echo "$EXEC_SUMMARY"
echo ""
echo "=================================================="
echo "TECHNICAL DETAILS"
echo "=================================================="
cat "$RAW_REPORT"

} > "$OUTPUT_LOG"

# ----------------------------------------------------------
# SIMPLE CLEAN HTML
# ----------------------------------------------------------

cat > "$OUTPUT_HTML" <<EOF
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>$HOSTNAME Executive Report</title>
<style>
body { font-family: Arial; background:#f4f6f9; padding:40px; }
.container { max-width:900px; margin:auto; }
.card { background:white; padding:25px; border-radius:10px; margin-bottom:25px; box-shadow:0 3px 10px rgba(0,0,0,0.05); }
.badge { padding:6px 14px; border-radius:20px; background:#2d7ff9; color:white; font-weight:bold; }
.metric { margin-bottom:8px; }
.footer { font-size:12px; color:#888; margin-top:30px; }
</style>
</head>
<body>
<div class="container">

<h1>$BRAND_NAME</h1>
<h3>Managed Systems Executive Report</h3>

<div class="card">
<strong>Host:</strong> $HOSTNAME<br>
<strong>Date:</strong> $DATE<br><br>
<strong>Overall Risk Level:</strong>
<span class="badge">$RISK</span>

<p style="margin-top:15px;">
$EXEC_SUMMARY
</p>
</div>

<div class="card">
<h3>System Health Snapshot</h3>
<div class="metric">Disk Usage: <strong>$DISK_USAGE%</strong></div>
<div class="metric">Memory Usage: <strong>$MEM_PERCENT%</strong></div>
<div class="metric">CPU Load: <strong>$LOAD_AVG</strong></div>
<div class="metric">Failed SSH Attempts: <strong>$FAILED_LOGINS</strong></div>
<div class="metric">Network RX: <strong>$RX_TOTAL</strong></div>
<div class="metric">Network TX: <strong>$TX_TOTAL</strong></div>
</div>

<div class="footer">
Generated by $BRAND_NAME | $DATE
</div>

</div>
</body>
</html>
EOF

echo "Reports generated:"
echo "$OUTPUT_LOG"
echo "$OUTPUT_HTML"
